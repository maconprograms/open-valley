name: Documentation Protection

on:
  pull_request:
    branches: [ main, master ]

jobs:
  protect-generated-docs:
    runs-on: ubuntu-latest
    name: Protect Generated Documentation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for direct edits to app/docs
      run: |
        echo "üîç Checking for direct edits to generated docs..."
        
        # Get list of modified files in this PR
        MODIFIED_FILES=$(git diff --name-only origin/main...HEAD)
        
        # Check if any files in app/docs were modified
        DOCS_FILES=$(echo "$MODIFIED_FILES" | grep "^app/docs/" || true)
        
        if [ -n "$DOCS_FILES" ]; then
          echo "‚ùå ERROR: Direct edits detected to generated documentation files:"
          echo "$DOCS_FILES"
          echo ""
          echo "üìù These files are generated from warren/documentation/"
          echo "Please edit the source files in warren/documentation instead:"
          echo ""
          for file in $DOCS_FILES; do
            SOURCE_FILE=${file#app/docs/}
            echo "  Instead of: $file"
            echo "  Edit this:  warren/documentation/$SOURCE_FILE"
            echo ""
          done
          echo "üí° The warren/open-valley/app/docs directory is generated by the docs:sync script."
          echo "   Only edit files in warren/documentation/ to maintain single source of truth."
          exit 1
        else
          echo "‚úÖ No direct edits to generated docs detected"
        fi

  check-sql-location:
    runs-on: ubuntu-latest
    name: Check SQL Location Rules
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check SQL only in schema.md
      run: |
        echo "üîç Checking SQL location rules..."
        
        # Get modified files
        MODIFIED_FILES=$(git diff --name-only origin/main...HEAD)
        
        # Check for SQL in non-schema files
        VIOLATIONS=""
        
        for file in $MODIFIED_FILES; do
          if [[ "$file" != */schema.md && "$file" == *.md ]]; then
            if grep -l "CREATE TABLE\|CREATE MATERIALIZED VIEW\|CREATE INDEX\|CREATE FUNCTION\|```sql" "$file" 2>/dev/null; then
              VIOLATIONS="$VIOLATIONS $file"
            fi
          fi
        done
        
        if [ -n "$VIOLATIONS" ]; then
          echo "‚ùå ERROR: SQL detected in non-schema files:"
          for file in $VIOLATIONS; do
            echo "  - $file"
            echo "    Found SQL content that should be in data/schema.md"
          done
          echo ""
          echo "üìù Documentation rule: All SQL must live only in data/schema.md"
          echo "   Link to schema.md from other pages instead of duplicating SQL."
          exit 1
        else
          echo "‚úÖ SQL location rules followed"
        fi

  check-docs-contract:
    runs-on: ubuntu-latest
    name: Check Documentation Contract
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for Docs Contract headers
      run: |
        echo "üîç Checking Documentation Contract compliance..."
        
        # Get modified .md files (excluding READMEs)
        MODIFIED_FILES=$(git diff --name-only origin/main...HEAD | grep '\.md$' | grep -v README.md || true)
        
        MISSING_CONTRACT=""
        
        for file in $MODIFIED_FILES; do
          if [ -f "$file" ]; then
            # Check if file has the required contract fields
            if ! grep -q "^Purpose" "$file" || \
               ! grep -q "^Audience" "$file" || \
               ! grep -q "^Status" "$file" || \
               ! grep -q "^Owner" "$file" || \
               ! grep -q "^Last updated" "$file"; then
              MISSING_CONTRACT="$MISSING_CONTRACT $file"
            fi
          fi
        done
        
        if [ -n "$MISSING_CONTRACT" ]; then
          echo "‚ùå ERROR: Documentation Contract headers missing or incomplete:"
          for file in $MISSING_CONTRACT; do
            echo "  - $file"
          done
          echo ""
          echo "üìù Required headers at the top of each documentation page:"
          echo "   Purpose: <what this page explains>"
          echo "   Audience: <who this is for>"
          echo "   Status: <canonical | guide | reference>"
          echo "   Owner: <responsible team>"
          echo "   Last updated: <YYYY-MM-DD>"
          echo ""
          echo "See: warren/documentation/reference/rules/documentation-rules.md"
          exit 1
        else
          echo "‚úÖ Documentation Contract headers present"
        fi

  terminology-check:
    runs-on: ubuntu-latest
    name: Check Terminology Rules
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check Warren VT terminology
      run: |
        echo "üîç Checking terminology rules..."
        
        # Get modified .md files
        MODIFIED_FILES=$(git diff --name-only origin/main...HEAD | grep '\.md$' || true)
        
        VIOLATIONS=""
        
        for file in $MODIFIED_FILES; do
          if [ -f "$file" ]; then
            # Check for "Members" instead of "People"
            if grep -n "\bMembers\b" "$file" | grep -v "team members\|committee members"; then
              echo "‚ö†Ô∏è  Warning: Found 'Members' in $file"
              echo "   Use 'People' when referring to the directory entity"
            fi
            
            # Check for non-standard agent terminology
            if grep -n -E "LangChain|OpenAI.*agent|Anthropic.*agent" "$file"; then
              echo "‚ö†Ô∏è  Warning: Found non-standard agent terminology in $file"
              echo "   Use 'LangGraph.js' for agents and workflow orchestration"
            fi
          fi
        done
        
        echo "‚úÖ Terminology check completed"